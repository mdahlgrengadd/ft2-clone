<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastTracker II Clone - Web Edition</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #ffffff;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            align-items: center;
            justify-content: center;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            color: #4a90e2;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .header p {
            font-size: 1.2em;
            margin: 5px 0;
            color: #cccccc;
        }
        
        .canvas-container {
            position: relative;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            background-color: #000000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #canvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            -ms-interpolation-mode: nearest-neighbor;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px;
            background-color: #2a2a2a;
            border-radius: 5px;
            border: 1px solid #4a90e2;
        }
        
        .control-group label {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }
        
        .control-button {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
            min-width: 80px;
        }
        
        .control-button:hover {
            background-color: #357abd;
        }
        
        .control-button:disabled {
            background-color: #666666;
            cursor: not-allowed;
        }
        
        .control-button.active {
            background-color: #27ae60;
        }
        
        .control-button.active:hover {
            background-color: #219a52;
        }
        
        .file-input {
            display: none;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            min-height: 20px;
            font-size: 14px;
        }
        
        .status.loading {
            background-color: #4a90e2;
            color: white;
        }
        
        .status.error {
            background-color: #e74c3c;
            color: white;
        }
        
        .status.success {
            background-color: #27ae60;
            color: white;
        }
        
        .info-text {
            font-size: 12px;
            color: #999999;
            margin-top: 20px;
            text-align: center;
            max-width: 800px;
            line-height: 1.4;
        }
        
        .loader {
            border: 4px solid #333;
            border-top: 4px solid #4a90e2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        #debug-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #ffffff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            z-index: 1000;
            min-width: 200px;
            border: 1px solid #4a90e2;
        }
        
        #resolution-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #ffffff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            z-index: 1000;
            border: 1px solid #4a90e2;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .control-group {
                width: 90%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FastTracker II Clone</h1>
            <p>Web Edition - Powered by Emscripten</p>
        </div>
        
        <div class="canvas-container" id="canvasContainer">
            <canvas id="canvas" width="632" height="400"></canvas>
        </div>
        
        <div id="debug-info" class="hidden">
            <div><strong>Mouse Debug Info:</strong></div>
            <div id="mouse-raw">Raw: (0, 0)</div>
            <div id="mouse-canvas">Canvas: (0, 0)</div>
            <div id="mouse-ft2">FT2: (0, 0)</div>
            <div id="canvas-size">Canvas: 632x400</div>
            <div id="render-area">Render Area: 632x400+0+0</div>
            <div id="aspect-info">Aspect: Canvas=1.58 FT2=1.58</div>
            <div><small>Press 'D' to toggle debug</small></div>
        </div>
        
        <div id="resolution-info" class="hidden">
            <div><strong>Resolution Info:</strong></div>
            <div id="res-scale">Scale: 1x</div>
            <div id="res-mode">Mode: Integer</div>
            <div id="res-size">Size: 632x400</div>
            <div id="res-display">Display: 632x400</div>
            <div><small>Press 'R' to toggle resolution info</small></div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>File Operations</label>
                <button class="control-button" id="loadFileBtn">Load Module</button>
                <button class="control-button" id="saveFileBtn" disabled>Save Module</button>
            </div>
            
            <div class="control-group">
                <label>Resolution Scale</label>
                <button class="control-button" id="scale1x">1x (632×400)</button>
                <button class="control-button" id="scale2x">2x (1264×800)</button>
                <button class="control-button active" id="scaleAuto">Auto Fit</button>
            </div>
            
            <div class="control-group">
                <label>Scaling Mode</label>
                <button class="control-button active" id="modeInteger">Integer Scale</button>
                <button class="control-button" id="modeStretch">Stretch</button>
            </div>
            
            <div class="control-group">
                <label>Display</label>
                <button class="control-button" id="fullscreenBtn">Fullscreen</button>
                <button class="control-button" id="resetBtn">Reset</button>
            </div>
        </div>
        
        <input type="file" id="fileInput" class="file-input" accept=".xm,.mod,.s3m,.it,.stm,.smp,.wav,.flac,.aiff">
        
        <div class="status" id="status">
            <div class="loader"></div>
            <div>Loading FastTracker II Clone...</div>
        </div>
        
        <div class="info-text">
            <p>
                This is a web port of the FastTracker II clone with enhanced resolution controls.
                Some features like MIDI support and audio recording are not available in the web version.
                Use the Load Module button to load your own music files, or explore the interface to create new music.
            </p>
            <p>
                <strong>Controls:</strong> Use your mouse and keyboard as you would in the desktop version.
                Press F11 for fullscreen mode. Use resolution controls above to adjust scaling and eliminate font artifacts.
            </p>
            <p>
                <strong>Resolution Tips:</strong> For best font quality, use Integer Scale mode with 1x or 2x scaling.
                Auto Fit mode uses the best integer scale that fits your screen.
            </p>
        </div>
    </div>

    <script>
        var statusDiv = document.getElementById('status');
        var loadFileBtn = document.getElementById('loadFileBtn');
        var saveFileBtn = document.getElementById('saveFileBtn');
        var fullscreenBtn = document.getElementById('fullscreenBtn');
        var resetBtn = document.getElementById('resetBtn');
        var fileInput = document.getElementById('fileInput');
        var canvas = document.getElementById('canvas');
        var canvasContainer = document.getElementById('canvasContainer');
        
        // Resolution control variables
        var currentScale = 'auto';
        var currentMode = 'integer';
        var baseWidth = 632;
        var baseHeight = 400;
        
        function updateStatus(message, type = 'loading') {
            statusDiv.className = 'status ' + type;
            statusDiv.innerHTML = type === 'loading' ? 
                '<div class="loader"></div><div>' + message + '</div>' : 
                '<div>' + message + '</div>';
        }
        
        // Resolution control functions
        function updateCanvasSize() {
            var scale = 1;
            var useIntegerScale = currentMode === 'integer';
            
            if (currentScale === 'auto') {
                // Calculate the best integer scale that fits the viewport
                var maxScale = Math.min(
                    Math.floor(window.innerWidth * 0.8 / baseWidth),
                    Math.floor(window.innerHeight * 0.6 / baseHeight)
                );
                scale = Math.max(1, maxScale);
            } else if (currentScale === '1x') {
                scale = 1;
            } else if (currentScale === '2x') {
                scale = 2;
            }
            
            if (useIntegerScale) {
                // Integer scaling for pixel-perfect rendering
                canvas.style.width = (baseWidth * scale) + 'px';
                canvas.style.height = (baseHeight * scale) + 'px';
                
                // Update container size
                canvasContainer.style.width = (baseWidth * scale + 4) + 'px';
                canvasContainer.style.height = (baseHeight * scale + 4) + 'px';
            } else {
                // Stretch mode - fill available space while maintaining aspect ratio
                var aspectRatio = baseWidth / baseHeight;
                var maxWidth = window.innerWidth * 0.8;
                var maxHeight = window.innerHeight * 0.6;
                
                var width, height;
                if (maxWidth / aspectRatio <= maxHeight) {
                    width = maxWidth;
                    height = maxWidth / aspectRatio;
                } else {
                    width = maxHeight * aspectRatio;
                    height = maxHeight;
                }
                
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';
                
                // Update container size
                canvasContainer.style.width = (width + 4) + 'px';
                canvasContainer.style.height = (height + 4) + 'px';
            }
            
            // Update resolution info
            updateResolutionInfo();
        }
        
        function updateResolutionInfo() {
            var scaleText = currentScale === 'auto' ? 'Auto' : currentScale;
            var modeText = currentMode === 'integer' ? 'Integer' : 'Stretch';
            var canvasRect = canvas.getBoundingClientRect();
            
            document.getElementById('res-scale').textContent = 'Scale: ' + scaleText;
            document.getElementById('res-mode').textContent = 'Mode: ' + modeText;
            document.getElementById('res-size').textContent = 'Size: ' + baseWidth + 'x' + baseHeight;
            document.getElementById('res-display').textContent = 'Display: ' + 
                Math.round(canvasRect.width) + 'x' + Math.round(canvasRect.height);
        }
        
        function setActiveScaleButton(activeId) {
            var buttons = ['scale1x', 'scale2x', 'scaleAuto'];
            buttons.forEach(function(id) {
                var btn = document.getElementById(id);
                if (id === activeId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        function setActiveModeButton(activeId) {
            var buttons = ['modeInteger', 'modeStretch'];
            buttons.forEach(function(id) {
                var btn = document.getElementById(id);
                if (id === activeId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // Resolution control event listeners
        document.getElementById('scale1x').addEventListener('click', function() {
            currentScale = '1x';
            setActiveScaleButton('scale1x');
            updateCanvasSize();
        });
        
        document.getElementById('scale2x').addEventListener('click', function() {
            currentScale = '2x';
            setActiveScaleButton('scale2x');
            updateCanvasSize();
        });
        
        document.getElementById('scaleAuto').addEventListener('click', function() {
            currentScale = 'auto';
            setActiveScaleButton('scaleAuto');
            updateCanvasSize();
        });
        
        document.getElementById('modeInteger').addEventListener('click', function() {
            currentMode = 'integer';
            setActiveModeButton('modeInteger');
            updateCanvasSize();
        });
        
        document.getElementById('modeStretch').addEventListener('click', function() {
            currentMode = 'stretch';
            setActiveModeButton('modeStretch');
            updateCanvasSize();
        });
        
        // File handling
        loadFileBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var data = new Uint8Array(e.target.result);
                    var filename = file.name;
                    
                    // Create file in Emscripten filesystem
                    if (typeof Module !== 'undefined' && Module.FS) {
                        try {
                            // Write to both root directory and current working directory
                            Module.FS.writeFile('/' + filename, data);
                            
                            // Also try to write to current directory
                            try {
                                var cwd = Module.FS.cwd();
                                if (cwd !== '/') {
                                    Module.FS.writeFile(cwd + '/' + filename, data);
                                    console.log('File also written to current directory:', cwd + '/' + filename);
                                }
                            } catch (cwdError) {
                                console.log('Could not write to current directory:', cwdError);
                            }
                            
                            updateStatus('File loaded: ' + filename + ' (available in disk operation)', 'success');
                            saveFileBtn.disabled = false;
                            
                            // List files for debugging
                            console.log('Available files:', Module.FS.readdir('/'));
                        } catch (error) {
                            updateStatus('Error loading file: ' + error.message, 'error');
                            console.error('File loading error:', error);
                        }
                    } else {
                        updateStatus('Application not ready yet', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });
        
        // Fullscreen
        fullscreenBtn.addEventListener('click', function() {
            if (canvas.requestFullscreen) {
                canvas.requestFullscreen();
            } else if (canvas.webkitRequestFullscreen) {
                canvas.webkitRequestFullscreen();
            } else if (canvas.msRequestFullscreen) {
                canvas.msRequestFullscreen();
            }
        });
        
        // Reset
        resetBtn.addEventListener('click', function() {
            if (typeof Module !== 'undefined' && Module.ccall) {
                // This would need to be implemented in the C code
                // Module.ccall('resetApplication', 'void', [], []);
                updateStatus('Reset functionality not implemented yet', 'error');
            }
        });
        
        // Keyboard handling
        document.addEventListener('keydown', function(e) {
            if (e.code === 'F11') {
                e.preventDefault();
                fullscreenBtn.click();
            }
        });
        
        // Module loading callbacks
        var Module = {
            preRun: [],
            postRun: [
                function() {
                    // Check for preloaded files
                    try {
                        if (Module.FS.findObject('/db_cydon.xm')) {
                            console.log('✅ Preloaded module found: db_cydon.xm');
                            updateStatus('Ready! (Preloaded module: db_cydon.xm available)', 'success');
                        }
                    } catch (e) {
                        console.log('No preloaded module found');
                        updateStatus('Ready!', 'success');
                    }
                    
                    // List all files in root directory for debugging
                    try {
                        const files = Module.FS.readdir('/');
                        console.log('Files in VFS root:', files);
                    } catch (e) {
                        console.log('Could not list VFS files:', e);
                    }
                }
            ],
            print: function(text) {
                console.log('stdout: ' + text);
            },
            printErr: function(text) {
                console.error('stderr: ' + text);
            },
            canvas: canvas,
            lastMouseEvent: null, // Store the last mouse event for C code access
            setStatus: function(text) {
                if (text) {
                    updateStatus(text, 'loading');
                } else {
                    updateStatus('Ready!', 'success');
                    // Enable controls when ready
                    loadFileBtn.disabled = false;
                    fullscreenBtn.disabled = false;
                    resetBtn.disabled = false;
                }
            },
            totalDependencies: 0,
            monitorRunDependencies: function(left) {
                this.totalDependencies = Math.max(this.totalDependencies, left);
                Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
            }
        };
        
        // Initial setup
        updateStatus('Initializing...', 'loading');
        
        // Focus canvas for keyboard input
        canvas.addEventListener('click', function() {
            canvas.focus();
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            updateCanvasSize();
        });
        
        // Debug info for mouse coordinates
        let debugVisible = false;
        let resolutionInfoVisible = false;
        
        function toggleDebug() {
            debugVisible = !debugVisible;
            const debugInfo = document.getElementById('debug-info');
            if (debugVisible) {
                debugInfo.classList.remove('hidden');
            } else {
                debugInfo.classList.add('hidden');
            }
        }
        
        function toggleResolutionInfo() {
            resolutionInfoVisible = !resolutionInfoVisible;
            const resolutionInfo = document.getElementById('resolution-info');
            if (resolutionInfoVisible) {
                resolutionInfo.classList.remove('hidden');
            } else {
                resolutionInfo.classList.add('hidden');
            }
        }
        
        // Toggle debug and resolution info with keyboard
        document.addEventListener('keydown', (e) => {
            if (e.code === 'KeyD' && !e.ctrlKey && !e.altKey && !e.metaKey) {
                toggleDebug();
            } else if (e.code === 'KeyR' && !e.ctrlKey && !e.altKey && !e.metaKey) {
                toggleResolutionInfo();
            }
        });
        
        // Mouse event tracking for C code integration
        function captureMouseEvent(e) {
            // Store the mouse event for C code access
            if (typeof Module !== 'undefined') {
                Module.lastMouseEvent = e;
            }
            
            // Update debug info if visible
            if (debugVisible) {
                const rect = canvas.getBoundingClientRect();
                const rawX = e.clientX;
                const rawY = e.clientY;
                const canvasX = e.clientX - rect.left;
                const canvasY = e.clientY - rect.top;
                
                // Calculate letterboxing/pillarboxing like the C code does
                const ft2AspectRatio = 632.0 / 400.0;
                const canvasAspectRatio = rect.width / rect.height;
                
                let renderW, renderH, renderX, renderY;
                
                if (canvasAspectRatio > ft2AspectRatio) {
                    // Pillarboxing (black bars on sides)
                    renderH = rect.height;
                    renderW = rect.height * ft2AspectRatio;
                    renderX = (rect.width - renderW) / 2;
                    renderY = 0;
                } else {
                    // Letterboxing (black bars on top/bottom)
                    renderW = rect.width;
                    renderH = rect.width / ft2AspectRatio;
                    renderX = 0;
                    renderY = (rect.height - renderH) / 2;
                }
                
                // Calculate FT2 coordinates within the rendered area
                let ft2X, ft2Y;
                if (canvasX >= renderX && canvasX < renderX + renderW &&
                    canvasY >= renderY && canvasY < renderY + renderH) {
                    // Mouse within rendered area
                    const relativeX = canvasX - renderX;
                    const relativeY = canvasY - renderY;
                    ft2X = Math.floor((relativeX * 632) / renderW);
                    ft2Y = Math.floor((relativeY * 400) / renderH);
                } else {
                    // Mouse outside rendered area (in letterbox/pillarbox)
                    if (canvasX < renderX) ft2X = 0;
                    else if (canvasX >= renderX + renderW) ft2X = 631;
                    else ft2X = Math.floor(((canvasX - renderX) * 632) / renderW);
                    
                    if (canvasY < renderY) ft2Y = 0;
                    else if (canvasY >= renderY + renderH) ft2Y = 399;
                    else ft2Y = Math.floor(((canvasY - renderY) * 400) / renderH);
                }
                
                document.getElementById('mouse-raw').textContent = `Raw: (${rawX}, ${rawY})`;
                document.getElementById('mouse-canvas').textContent = `Canvas: (${Math.floor(canvasX)}, ${Math.floor(canvasY)})`;
                document.getElementById('mouse-ft2').textContent = `FT2: (${ft2X}, ${ft2Y})`;
                document.getElementById('canvas-size').textContent = `Canvas: ${Math.floor(rect.width)}x${Math.floor(rect.height)}`;
                document.getElementById('render-area').textContent = `Render Area: ${Math.floor(renderW)}x${Math.floor(renderH)}+${Math.floor(renderX)}+${Math.floor(renderY)}`;
                document.getElementById('aspect-info').textContent = `Aspect: Canvas=${canvasAspectRatio.toFixed(2)} FT2=${ft2AspectRatio.toFixed(2)}`;
            }
        }
        
        // Track all mouse events on canvas
        canvas.addEventListener('mousemove', captureMouseEvent);
        canvas.addEventListener('mousedown', captureMouseEvent);
        canvas.addEventListener('mouseup', captureMouseEvent);
        canvas.addEventListener('click', captureMouseEvent);
        
        // Also track mouse events outside canvas for when mouse leaves canvas bounds
        document.addEventListener('mousemove', (e) => {
            if (typeof Module !== 'undefined') {
                Module.lastMouseEvent = e;
            }
        });
        
        // Initialize canvas size
        updateCanvasSize();
    </script>
    
    {{{ SCRIPT }}}
</body>
</html> 