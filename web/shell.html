<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastTracker II Clone - Web Edition</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #ffffff;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            align-items: center;
            justify-content: center;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            color: #4a90e2;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .header p {
            font-size: 1.2em;
            margin: 5px 0;
            color: #cccccc;
        }
        
        .canvas-container {
            position: relative;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            background-color: #000000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        #canvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-button {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .control-button:hover {
            background-color: #357abd;
        }
        
        .control-button:disabled {
            background-color: #666666;
            cursor: not-allowed;
        }
        
        .file-input {
            display: none;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            min-height: 20px;
            font-size: 14px;
        }
        
        .status.loading {
            background-color: #4a90e2;
            color: white;
        }
        
        .status.error {
            background-color: #e74c3c;
            color: white;
        }
        
        .status.success {
            background-color: #27ae60;
            color: white;
        }
        
        .info-text {
            font-size: 12px;
            color: #999999;
            margin-top: 20px;
            text-align: center;
            max-width: 600px;
            line-height: 1.4;
        }
        
        .loader {
            border: 4px solid #333;
            border-top: 4px solid #4a90e2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        #debug-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #ffffff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            z-index: 1000;
            min-width: 200px;
            border: 1px solid #4a90e2;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .canvas-container {
                width: 95vw;
                height: auto;
            }
            
            #canvas {
                width: 100%;
                height: auto;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FastTracker II Clone</h1>
            <p>Web Edition - Powered by Emscripten</p>
        </div>
        
        <div class="canvas-container">
            <canvas id="canvas" width="632" height="400"></canvas>
        </div>
        
        <div id="debug-info" class="hidden">
            <div><strong>Mouse Debug Info:</strong></div>
            <div id="mouse-raw">Raw: (0, 0)</div>
            <div id="mouse-canvas">Canvas: (0, 0)</div>
            <div id="mouse-ft2">FT2: (0, 0)</div>
            <div id="canvas-size">Canvas: 632x400</div>
            <div id="render-area">Render Area: 632x400+0+0</div>
            <div id="aspect-info">Aspect: Canvas=1.58 FT2=1.58</div>
            <div><small>Press 'D' to toggle debug</small></div>
        </div>
        
        <div class="controls">
            <button class="control-button" id="loadFileBtn">Load Module</button>
            <button class="control-button" id="saveFileBtn" disabled>Save Module</button>
            <button class="control-button" id="fullscreenBtn">Fullscreen</button>
            <button class="control-button" id="resetBtn">Reset</button>
        </div>
        
        <input type="file" id="fileInput" class="file-input" accept=".xm,.mod,.s3m,.it,.stm,.smp,.wav,.flac,.aiff">
        
        <div class="status" id="status">
            <div class="loader"></div>
            <div>Loading FastTracker II Clone...</div>
        </div>
        
        <div class="info-text">
            <p>
                This is a web port of the FastTracker II clone. 
                Some features like MIDI support and audio recording are not available in the web version.
                Use the Load Module button to load your own music files, or explore the interface to create new music.
            </p>
            <p>
                <strong>Controls:</strong> Use your mouse and keyboard as you would in the desktop version.
                Press F11 for fullscreen mode.
            </p>
        </div>
    </div>

    <script>
        var statusDiv = document.getElementById('status');
        var loadFileBtn = document.getElementById('loadFileBtn');
        var saveFileBtn = document.getElementById('saveFileBtn');
        var fullscreenBtn = document.getElementById('fullscreenBtn');
        var resetBtn = document.getElementById('resetBtn');
        var fileInput = document.getElementById('fileInput');
        var canvas = document.getElementById('canvas');
        
        function updateStatus(message, type = 'loading') {
            statusDiv.className = 'status ' + type;
            statusDiv.innerHTML = type === 'loading' ? 
                '<div class="loader"></div><div>' + message + '</div>' : 
                '<div>' + message + '</div>';
        }
        
        // File handling
        loadFileBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var data = new Uint8Array(e.target.result);
                    var filename = file.name;
                    
                    // Create file in Emscripten filesystem
                    if (typeof Module !== 'undefined' && Module.FS) {
                        try {
                            // Write to both root directory and current working directory
                            Module.FS.writeFile('/' + filename, data);
                            
                            // Also try to write to current directory
                            try {
                                var cwd = Module.FS.cwd();
                                if (cwd !== '/') {
                                    Module.FS.writeFile(cwd + '/' + filename, data);
                                    console.log('File also written to current directory:', cwd + '/' + filename);
                                }
                            } catch (cwdError) {
                                console.log('Could not write to current directory:', cwdError);
                            }
                            
                            updateStatus('File loaded: ' + filename + ' (available in disk operation)', 'success');
                            saveFileBtn.disabled = false;
                            
                            // List files for debugging
                            console.log('Available files:', Module.FS.readdir('/'));
                        } catch (error) {
                            updateStatus('Error loading file: ' + error.message, 'error');
                            console.error('File loading error:', error);
                        }
                    } else {
                        updateStatus('Application not ready yet', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });
        
        // Fullscreen
        fullscreenBtn.addEventListener('click', function() {
            if (canvas.requestFullscreen) {
                canvas.requestFullscreen();
            } else if (canvas.webkitRequestFullscreen) {
                canvas.webkitRequestFullscreen();
            } else if (canvas.msRequestFullscreen) {
                canvas.msRequestFullscreen();
            }
        });
        
        // Reset
        resetBtn.addEventListener('click', function() {
            if (typeof Module !== 'undefined' && Module.ccall) {
                // This would need to be implemented in the C code
                // Module.ccall('resetApplication', 'void', [], []);
                updateStatus('Reset functionality not implemented yet', 'error');
            }
        });
        
        // Keyboard handling
        document.addEventListener('keydown', function(e) {
            if (e.code === 'F11') {
                e.preventDefault();
                fullscreenBtn.click();
            }
        });
        
        // Module loading callbacks
        var Module = {
            preRun: [],
            postRun: [
                function() {
                    // Check for preloaded files
                    try {
                        if (Module.FS.findObject('/db_cydon.xm')) {
                            console.log('✅ Preloaded module found: db_cydon.xm');
                            updateStatus('Ready! (Preloaded module: db_cydon.xm available)', 'success');
                        }
                    } catch (e) {
                        console.log('No preloaded module found');
                        updateStatus('Ready!', 'success');
                    }
                    
                    // List all files in root directory for debugging
                    try {
                        const files = Module.FS.readdir('/');
                        console.log('Files in VFS root:', files);
                    } catch (e) {
                        console.log('Could not list VFS files:', e);
                    }
                }
            ],
            print: function(text) {
                console.log('stdout: ' + text);
            },
            printErr: function(text) {
                console.error('stderr: ' + text);
            },
            canvas: canvas,
            lastMouseEvent: null, // Store the last mouse event for C code access
            setStatus: function(text) {
                if (text) {
                    updateStatus(text, 'loading');
                } else {
                    updateStatus('Ready!', 'success');
                    // Enable controls when ready
                    loadFileBtn.disabled = false;
                    fullscreenBtn.disabled = false;
                    resetBtn.disabled = false;
                }
            },
            totalDependencies: 0,
            monitorRunDependencies: function(left) {
                this.totalDependencies = Math.max(this.totalDependencies, left);
                Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
            }
        };
        
        // Initial setup
        updateStatus('Initializing...', 'loading');
        
        // Focus canvas for keyboard input
        canvas.addEventListener('click', function() {
            canvas.focus();
        });
        
        // Handle canvas resize
        function resizeCanvas() {
            var container = document.querySelector('.canvas-container');
            var rect = container.getBoundingClientRect();
            // Maintain aspect ratio
            var aspectRatio = 632 / 400;
            var maxWidth = Math.min(rect.width, window.innerWidth * 0.9);
            var maxHeight = Math.min(rect.height, window.innerHeight * 0.6);
            
            if (maxWidth / aspectRatio <= maxHeight) {
                canvas.style.width = maxWidth + 'px';
                canvas.style.height = (maxWidth / aspectRatio) + 'px';
            } else {
                canvas.style.width = (maxHeight * aspectRatio) + 'px';
                canvas.style.height = maxHeight + 'px';
            }
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        // Debug info for mouse coordinates
        let debugVisible = false;
        
        function toggleDebug() {
            debugVisible = !debugVisible;
            const debugInfo = document.getElementById('debug-info');
            if (debugVisible) {
                debugInfo.classList.remove('hidden');
            } else {
                debugInfo.classList.add('hidden');
            }
        }
        
        // Toggle debug with 'D' key
        document.addEventListener('keydown', (e) => {
            if (e.code === 'KeyD' && !e.ctrlKey && !e.altKey && !e.metaKey) {
                toggleDebug();
            }
        });
        
        // Mouse event tracking for C code integration
        function captureMouseEvent(e) {
            // Store the mouse event for C code access
            if (typeof Module !== 'undefined') {
                Module.lastMouseEvent = e;
            }
            
            // Update debug info if visible
            if (debugVisible) {
                const rect = canvas.getBoundingClientRect();
                const rawX = e.clientX;
                const rawY = e.clientY;
                const canvasX = e.clientX - rect.left;
                const canvasY = e.clientY - rect.top;
                
                // Calculate letterboxing/pillarboxing like the C code does
                const ft2AspectRatio = 632.0 / 400.0;
                const canvasAspectRatio = rect.width / rect.height;
                
                let renderW, renderH, renderX, renderY;
                
                if (canvasAspectRatio > ft2AspectRatio) {
                    // Pillarboxing (black bars on sides)
                    renderH = rect.height;
                    renderW = rect.height * ft2AspectRatio;
                    renderX = (rect.width - renderW) / 2;
                    renderY = 0;
                } else {
                    // Letterboxing (black bars on top/bottom)
                    renderW = rect.width;
                    renderH = rect.width / ft2AspectRatio;
                    renderX = 0;
                    renderY = (rect.height - renderH) / 2;
                }
                
                // Calculate FT2 coordinates within the rendered area
                let ft2X, ft2Y;
                if (canvasX >= renderX && canvasX < renderX + renderW &&
                    canvasY >= renderY && canvasY < renderY + renderH) {
                    // Mouse within rendered area
                    const relativeX = canvasX - renderX;
                    const relativeY = canvasY - renderY;
                    ft2X = Math.floor((relativeX * 632) / renderW);
                    ft2Y = Math.floor((relativeY * 400) / renderH);
                } else {
                    // Mouse outside rendered area (in letterbox/pillarbox)
                    if (canvasX < renderX) ft2X = 0;
                    else if (canvasX >= renderX + renderW) ft2X = 631;
                    else ft2X = Math.floor(((canvasX - renderX) * 632) / renderW);
                    
                    if (canvasY < renderY) ft2Y = 0;
                    else if (canvasY >= renderY + renderH) ft2Y = 399;
                    else ft2Y = Math.floor(((canvasY - renderY) * 400) / renderH);
                }
                
                document.getElementById('mouse-raw').textContent = `Raw: (${rawX}, ${rawY})`;
                document.getElementById('mouse-canvas').textContent = `Canvas: (${Math.floor(canvasX)}, ${Math.floor(canvasY)})`;
                document.getElementById('mouse-ft2').textContent = `FT2: (${ft2X}, ${ft2Y})`;
                document.getElementById('canvas-size').textContent = `Canvas: ${Math.floor(rect.width)}x${Math.floor(rect.height)}`;
                document.getElementById('render-area').textContent = `Render Area: ${Math.floor(renderW)}x${Math.floor(renderH)}+${Math.floor(renderX)}+${Math.floor(renderY)}`;
                document.getElementById('aspect-info').textContent = `Aspect: Canvas=${canvasAspectRatio.toFixed(2)} FT2=${ft2AspectRatio.toFixed(2)}`;
            }
        }
        
        // Track all mouse events on canvas
        canvas.addEventListener('mousemove', captureMouseEvent);
        canvas.addEventListener('mousedown', captureMouseEvent);
        canvas.addEventListener('mouseup', captureMouseEvent);
        canvas.addEventListener('click', captureMouseEvent);
        
        // Also track mouse events outside canvas for when mouse leaves canvas bounds
        document.addEventListener('mousemove', (e) => {
            if (typeof Module !== 'undefined') {
                Module.lastMouseEvent = e;
            }
        });
    </script>
    
    {{{ SCRIPT }}}
</body>
</html> 