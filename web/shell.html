<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>FastTracker II Clone</title>
    <style>
        /* zero-chrome, black background */
        html,body{height:100%;margin:0;background:#000;display:flex;align-items:center;justify-content:center}
        /* ensure pixel-perfect upscaling */
        #canvas{image-rendering:pixelated;image-rendering:-moz-crisp-edges;image-rendering:crisp-edges}
    </style>
</head>
<body>
    <canvas id="canvas" width="632" height="400"></canvas>

    <script>
        /* minimal Module definition for the Emscripten runtime + FT2 mouse fixes */
        const canvas = document.getElementById('canvas');
        
        // Global flag to track if persistent storage is ready
        var persistentStorageReady = false;
        var originalMain = null;
        
        var Module = {
            canvas: canvas,
            lastMouseEvent: null,
            /* stubs so the runtime doesn't complain */
            setStatus:            function() {},
            monitorRunDependencies:function() {},
            print:               function(t){console.log(t)},
            printErr:            function(t){console.error(t)},
            postRun:             [],
            
            /* Prevent automatic main execution */
            noInitialRun: true,
            
            /* Initialize storage when runtime is ready */
            onRuntimeInitialized: function() {
                console.log('Runtime initialized, setting up persistent storage...');
                initPersistentStorage();
            },
            
            /* Persistent storage initialization - simplified preRun */
            preRun: []
        };

        /* Function to initialize persistent storage and sync */
        function initPersistentStorage() {
            console.log('Initializing persistent storage...');
            
            try {
                // Create persistent directories
                FS.mkdir('/persistent');
                FS.mkdir('/persistent/modules');
                FS.mkdir('/persistent/samples');
                FS.mkdir('/persistent/instruments');
                FS.mkdir('/persistent/config');
                
                // Mount IDBFS for persistent storage
                FS.mount(IDBFS, {}, '/persistent');
                
                // Create a symbolic link from /home/web_user to /persistent for compatibility
                try {
                    FS.mkdir('/home');
                    FS.symlink('/persistent', '/home/web_user');
                    console.log('Created /home/web_user symlink to /persistent');
                } catch(e) {
                    console.log('Note: /home/web_user symlink creation failed (may already exist)');
                }
                
                // Sync from IndexedDB to populate the filesystem BEFORE marking ready
                console.log('Syncing persistent storage from IndexedDB...');
                FS.syncfs(true, function(err) {
                    if (err) {
                        console.log('Error loading persistent data:', err);
                    } else {
                        console.log('Persistent storage loaded successfully');
                    }
                    
                    // Mark storage as ready and start the main application
                    persistentStorageReady = true;
                    console.log('Persistent storage initialization complete - starting main application');
                    
                    // Now call the main function
                    try {
                        Module.callMain();
                    } catch(e) {
                        console.log('Error calling main:', e);
                        // Fallback to direct call
                        if (Module._main) {
                            Module._main();
                        }
                    }
                });
                
            } catch(e) {
                console.error('Error initializing persistent storage:', e);
                // Mark as ready even on error so app can start
                persistentStorageReady = true;
                
                // Still try to start the app
                try {
                    Module.callMain();
                } catch(e2) {
                    if (Module._main) {
                        Module._main();
                    }
                }
            }
        }

        Module.postRun = [function() {
            console.log('FastTracker II Clone post-run');
            
            // Set up periodic sync every 30 seconds
            setInterval(function() {
                if (typeof FS !== 'undefined' && FS.syncfs) {
                    FS.syncfs(false, function(err) {
                        if (!err) {
                            console.log('Periodic sync completed');
                        }
                    });
                }
            }, 30000);
            
            // Set up cleanup on page unload
            window.addEventListener('beforeunload', function() {
                if (typeof FS !== 'undefined' && FS.syncfs) {
                    FS.syncfs(false, function(err) {
                        console.log('Final sync on page unload', err ? 'failed' : 'completed');
                    });
                }
            });
        }];

        /* feed mouse events to C code (see ft2_mouse.c EM_ASM blocks) */
        function storeEvt(e){ 
            if (Module) Module.lastMouseEvent = e; 
        }
        
        // Safely add event listeners
        if (canvas) {
            ['mousemove','mousedown','mouseup','click'].forEach(evt => {
                canvas.addEventListener(evt, storeEvt);
            });
            canvas.addEventListener('click', () => canvas.focus());
        }
        
        document.addEventListener('mousemove', storeEvt); // when pointer leaves canvas
    </script>

    {{{ SCRIPT }}}
</body>
</html>