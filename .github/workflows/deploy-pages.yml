name: Deploy FastTracker II Clone to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Verify WebAssembly build exists
      run: |
        echo "Checking for existing WebAssembly build..."
        ls -la build_emscripten/web/
        echo ""
        echo "‚úÖ Required files:"
        test -f build_emscripten/web/ft2-clone.html && echo "  ‚úÖ ft2-clone.html found"
        test -f build_emscripten/web/ft2-clone.js && echo "  ‚úÖ ft2-clone.js found" 
        test -f build_emscripten/web/ft2-clone.wasm && echo "  ‚úÖ ft2-clone.wasm found"
        test -f build_emscripten/web/ft2-clone.data && echo "  ‚úÖ ft2-clone.data found"
        echo ""
        echo "üìä File sizes:"
        du -h build_emscripten/web/*
        
    - name: Create GitHub Pages structure
      run: |
        # Create pages directory
        mkdir -p pages
        
        # Copy all built web files
        cp -r build_emscripten/web/* pages/
        
        # Create index.html that redirects to ft2-clone.html
        cat > pages/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta http-equiv="refresh" content="0; url=ft2-clone.html">
            <title>FastTracker II Clone</title>
            <style>
                body {
                    margin: 0;
                    padding: 20px;
                    font-family: Arial, sans-serif;
                    background: #000;
                    color: #fff;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 100vh;
                }
                .container {
                    text-align: center;
                    max-width: 600px;
                }
                .logo {
                    font-size: 2.5em;
                    margin-bottom: 20px;
                    color: #4CAF50;
                }
                .subtitle {
                    font-size: 1.2em;
                    margin-bottom: 30px;
                    color: #ccc;
                }
                .loading {
                    font-size: 1em;
                    color: #888;
                }
                a {
                    color: #4CAF50;
                    text-decoration: none;
                }
                a:hover {
                    text-decoration: underline;
                }
                .features {
                    margin-top: 30px;
                    text-align: left;
                    color: #aaa;
                    font-size: 0.9em;
                }
                .feature {
                    margin: 8px 0;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="logo">üéµ FastTracker II Clone</div>
                <div class="subtitle">WebAssembly Music Tracker</div>
                <div class="loading">Loading... If not redirected automatically, <a href="ft2-clone.html">click here to launch</a></div>
                
                <div class="features">
                    <div class="feature">üéµ Full FastTracker II compatibility</div>
                    <div class="feature">üíæ Persistent browser storage</div>
                    <div class="feature">üé® "Why Colors?" theme by default</div>
                    <div class="feature">üìÅ Drag & drop module files</div>
                    <div class="feature">üîÑ Automatic file management</div>
                    <div class="feature">üåê Runs entirely in your browser</div>
                </div>
            </div>
            <script>
                // Fallback redirect after 3 seconds
                setTimeout(function() {
                    if (window.location.pathname.endsWith('index.html') || window.location.pathname.endsWith('/')) {
                        window.location.href = 'ft2-clone.html';
                    }
                }, 3000);
            </script>
        </body>
        </html>
        EOF
        
        # Create a README for the pages
        cat > pages/README.md << 'EOF'
        # FastTracker II Clone - Web Version
        
        üéµ **Live Demo:** [https://mdahlgrengadd.github.io/ft2-clone](https://mdahlgrengadd.github.io/ft2-clone)
        
        ## Features
        - üéµ Full FastTracker II compatibility
        - üíæ Persistent storage using IndexedDB
        - üé® "Why Colors?" theme by default
        - üìÅ Drag & drop module file upload
        - üîÑ Automatic directory refresh
        - üåê Runs entirely in your browser (no plugins needed)
        
        ## Supported Formats
        - XM (Extended Module)
        - MOD (Amiga Module) 
        - S3M (Scream Tracker 3)
        - IT (Impulse Tracker)
        - And many more tracker formats
        
        ## Usage
        1. Visit the website
        2. Click to start the application
        3. Drag and drop .xm, .mod, .s3m files onto the interface
        4. Your settings and uploaded files are automatically saved
        
        ## Technical Details
        - Built with Emscripten WebAssembly
        - Uses IDBFS for persistent browser storage
        - Optimized for modern web browsers
        - Zero-latency audio processing
        
        ## About
        This is a web port of the FastTracker II Clone, automatically deployed from the repository.
        EOF
        
        echo ""
        echo "üöÄ GitHub Pages structure created:"
        ls -la pages/
        echo ""
        echo "üìÅ Total deployment size:"
        du -sh pages/
        
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./pages

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Deployment Summary
      run: |
        echo "## üéµ FastTracker II Clone Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ **Status:** Successfully deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ÔøΩ **Live URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üéπ Features Available:" >> $GITHUB_STEP_SUMMARY
        echo "- üéµ Full FastTracker II Clone functionality" >> $GITHUB_STEP_SUMMARY
        echo "- üíæ Persistent storage with IDBFS" >> $GITHUB_STEP_SUMMARY
        echo "- üé® 'Why Colors?' theme by default" >> $GITHUB_STEP_SUMMARY
        echo "- üìÅ Drag & drop module file upload" >> $GITHUB_STEP_SUMMARY
        echo "- üîÑ Automatic directory refresh" >> $GITHUB_STEP_SUMMARY
        echo "- üåê Zero-installation web experience" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üéº Ready to use!" >> $GITHUB_STEP_SUMMARY
        echo "Just visit the URL above and start making music!" >> $GITHUB_STEP_SUMMARY
